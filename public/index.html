<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <script src="csv_parse.js"></script>
  <link rel="stylesheet" href="style.css">
  <title>Steam Deck Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <div class="banner">
    <img src="Images/SteamDeck.png" style="height: 60px; z-index: -1; position: absolute; margin-top: 20px;"/>
    <p class="banner_text"> Steam Deck: Expected Order Date Calculator</p>
  </div>

  <div class="calculator_parameters">
    <div class="class_parameter">
      <p>
        This calculator is designed to allow for extending it's ability as Valve releases more information.
        The form that is provided collects as much data as possible, and is ready for collecting order confirmation
        emails too.
        If anyone has their own data they have collected please contribute it, or let me know! If you are a developer,
        or have
        an algo you want to add, please contribute!
      </p>

      <h3 style="padding-top: 1em;">How does it work?</h3>

      <p style="max-width: 80em;">
        <ul>
          <li>
          Moo's method attempts to simulate the number of deck orders each minute and Valve's throughput of decks each day.
          Then it calculates the estimated ship date based on throughput each day. It supports almost any date, but is most
          accurate for the first
          day of orders and the 512GB model due to that being where most of the sample data is. This algo also generates a lot
          of cool data,
          like orders over time, how many units will ship each month, etc... TODO extract and display the data.
          </li>
        <li> 
          Gecked's method interpolates estimated dates in the sample data. This means it does not support After Q2 dates.
        </li>
        <li>
          Abyzma's method randomly selects a date within your quarter
        </li>
        </ul>
      </p>

      <p style="padding-top: 1em;">
        Orders are sent on a weekly basis. Each batch of emails will be on Mondays except launch day (<a
          href="https://store.steampowered.com/news/app/1675180/view/3113680716504852534">source</a>)<br> Release was
        Feb
        25th 10am est.
      </p>

      <p style="font-weight: bold;">
        Disclaimer: This is an estimator. It creates magic numbers out of thin air. Assume the magic numbers are wrong.
        But copium is addicting!
      </p>
    </div>

    <div class="calculator_parameter">
      <div class="calculator_parameter_header">
        <p> Step 1 </p>
      </div>
      <div class="calculator_parameter_body">
        1. Fill out <a href='https://forms.gle/vfU1UwU3NoYXNmiG8' target="_blank">Steam Deck Shipment estimator form</a>
        with your
        information:
        <a href="https://docs.google.com/spreadsheets/d/1QqlSUpqhyBCBYeu_gW4w5vIxfcd7qablSviALDFJ0Dg/edit?usp=sharing"
          target="_blank">Link
          to results
          spreadsheet</a><br>
        <!-- <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSfLZaRMIVknUubuHjhfXU_x6VEAifId-n7rIhi6DVTPTcLWNw/viewform?embedded=true" width="600" height="600" frameborder="0" marginheight="0" marginwidth="0">Loadingâ€¦</iframe><br> -->
      </div>
    </div>

    <div class="calculator_parameter">
      <div class="calculator_parameter_header">
        <p> Step 2: Model </p>
      </div>
      <div class="calculator_parameter_body">
        <select name="Model" id="model" onchange="updateAndStore('model')">
          <option value="64">64 GB</option>
          <option value="256">256 GB</option>
          <option value="512">512 GB</option>
        </select>
      </div>
    </div>

    <div class="calculator_parameter">
      <div class="calculator_parameter_header">
        <p> Step 3: Region </p>
      </div>
      <div class="calculator_parameter_body">
        <select name="Region" id="region" onchange="updateAndStore('region')">
          <option value="US">US</option>
          <option value="UK">UK</option>
          <option value="EU">EU</option>
        </select>
      </div>
    </div>

    <div class="calculator_parameter">
      <div class="calculator_parameter_header">
        <p> Step 4: Current Valve Estimated Order Availability </p>
      </div>
      <div class="calculator_parameter_body">
        <select name="Order availabilty" id="order_avail" onchange="updateAndStore('order_avail')">
          <option value="Q1">Q1</option>
          <option value="Q2">Q2</option>
          <option value="Q3">Q3</option>
          <option value="After Q3">After Q3</option>
        </select>
      </div>
    </div>

    <div class="calculator_parameter">
      <div class="calculator_parameter_header">
        <p> Step 5: Getting the rtReserveTime </p>
      </div>
      <div class="calculator_parameter_body" style="height: 200px;">
        <input type="number" step="60" id="rtReserveTime" onchange="updateTimeDisplay()"> <span
          id="time_display"></span>
        <h5 class="indent">Method A:
          <a
            href="steam://openurl/https://store.steampowered.com/reservation/ajaxgetuserstate?rgReservationPackageIDs=%5B595603,595604,595605%5D"><button>View
              in Steam</button></a>
          and copy rtReserveTime from the response. <i>If you see a black screen, highlight or press CTRL + A to
            highlight, the text might also be black</i>
        </h5>
        <h5 class="indent">Method B: Log into Steam on your browser. Then visit
          <a href="https://store.steampowered.com/reservation/ajaxgetuserstate?rgReservationPackageIDs=%5B595603,595604,595605%5D"
            target="_blank">the API for reservations</a>
          . Copy rtReserveTime from the response.
        </h5>
        <h5 class="indent">Method C: You can also use the received time of your pre-order email if you convert it to an
          unix timestamp (<a href="https://www.epochconverter.com/" target="_blank">epochconverter.com</a>)</h5>
      </div>
    </div>

    <div class="calculator_parameter">
      <div class="calculator_parameter_header">
        <p>Step 6: Import data (Using: <span id="loaded_data"><i>No data imported </i></span>)</p>
      </div>
      <div class="calculator_parameter_body" style="height:150px">
        <div class="indent">
          <!-- <button onclick="getData('latest.csv')">moo latest (imported never. not enough data yet)</button><br> -->
          <button onclick="getData('3-26-22-moo.csv')">moo (~2800 responses)</button><br><br>
          <button onclick="getData('2-11-22-hoxeel-filtered.csv')">u/hoxeel filtered (~1400 responses)</button><br><br>
          <!-- <button onclick="getData('2-9-22-moo.csv')"> (~1600 responses imported)</button><br><br> -->
          Upload the latest data manually. Export the <a
            href="https://docs.google.com/spreadsheets/d/1QqlSUpqhyBCBYeu_gW4w5vIxfcd7qablSviALDFJ0Dg/edit?usp=sharing"
            target="_blank">spreadsheet</a> as a CSV, then upload it
          here.
          <input type="file" id="file" />
        </div>
      </div>
    </div>

    <div class=" calculator_parameter">
      <div class="calculator_parameter_header">
        <p>Step 7: Calculate your estimated order availabilty date, or contribute your own! </p>
      </div>
      <div class="calculator_parameter_body" style="height:80px">
        <div class="centered warp" style="padding-top: 1em;">
          <button class="bigbutton" onclick="calculate(mooV2)">moo (v2 model)</button>
          <a href="https://replit.com/@jplayzgamegm/SDDC?v=1"><button class="bigbutton">gecked (link)</button></a>
          <button class="bigbutton" onclick="calculate(abyzma)">abyzma</button>
          <a href="https://colab.research.google.com/drive/1TzC_cQIIhplKAd1ceHxABS9FFtFaoyMt"><button
              class="bigbutton">jimmosio (link)</button></a>
        </div>
      </div>
    </div>

    <div class="calculator_parameter">
      <div class="calculator_parameter_header">
        <p>Your Results</p>
      </div>
      <div class="calculator_parameter_body" style="height:120px">
        <div style="text-align: center; padding-top: 0;" id="results">
          <h1>
            Estimated Order Date: ????????????<br>
            ??? day(s) ?? hour(s) ?? minute(s) ?? second(s)
          </h1>
        </div>
      </div>
    </div>
  </div>
</body>

<footer class="footer">
  <p class="footer_text">Created by moo, contribute on <a
      href="https://github.com/MooNag/steam-deck-calculator">GitHub</a></p>
</footer>
</html>
<script>

  loaded_data = null;
  result = null;
  calculate_error = null;

  function getLocalStorageOrDefault(item) {
    const defaults = {
      region: "US",
      model: "256",
      rtReserveTime: "1626454969",
      order_avail: "Q1",
    }
    if (localStorage.getItem(item) == null) {
      return defaults[item];
    }
    return localStorage.getItem(item);
  }

  //clear file input
  document.getElementById("file").value = null;

  //Load data from local-storage
  document.getElementById('region').value = getLocalStorageOrDefault("region");
  document.getElementById('model').value = getLocalStorageOrDefault("model");
  document.getElementById('rtReserveTime').value = getLocalStorageOrDefault("rtReserveTime");
  document.getElementById('order_avail').value = getLocalStorageOrDefault("order_avail");

  //Called when a form item changes state. Stores the value into local storage for later use.
  function updateAndStore(item) {
    const value = document.getElementById(item).value;
    localStorage.setItem(item, value);
  }

  function updateTimeDisplay() {
    updateAndStore('rtReserveTime');
    const date = new Date(document.getElementById('rtReserveTime').value * 1000);
    document.getElementById('time_display').innerHTML = `${date.toDateString()} ${date.toTimeString()}`;
  }

  function customFileUpload(evt) {
    var file = evt.target.files[0]; // FileList object
    var reader = new FileReader();
    reader.readAsText(file, "UTF-8");
    reader.onload = function (evt) {
      dataFromCSVString(evt.target.result, file.name);
    }
  }
  document.getElementById('file').addEventListener('change', customFileUpload, false);

  //Do the fun stuff to display the things!
  function update_data() {
    if (calculate_error != null) {
      document.getElementById('results').innerHTML = `<h1 style="color: red;">${calculate_error}</h1>`;
      return;
    }
    if (result !== null) {
      //Calculate the order email time.
      let launchTime = new Date(1646071200000); //feb 25th 10pm est
      var emailTime = undefined;
      while (new Date(result).getTime() > launchTime.getTime()) {
        emailTime = launchTime;
        launchTime = new Date(launchTime.getTime() + 6.048e+8);
      }

      const date = new Date(emailTime);
      const diff = date.getTime() - Date.now();

      document.getElementById('results').innerHTML = `
      <h3>${algo} (${new Date(Date.now()).toDateString()})</h3>
      <h2>Estimated Order Date: ${date.toDateString()}<br>
      ${Math.floor(diff / (1000 * 60 * 60 * 24))} day(s)
      ${Math.floor((diff / (1000 * 60 * 60)) % 24)} hour(s)
      ${Math.floor((diff / 1000 / 60) % 60)} minute(s)
      ${Math.floor((diff / 1000) % 60)} second(s)</h2>
      
      
      `;
    }
  }
  setInterval(update_data, 1000);

  updateTimeDisplay();
</script>

<script>

  class Response {
    constructor(data) {
      this.timestamp = data[0]; //2/8/2022 15:34:25
      this.region = data[1]; //"US", "EU", "UK"
      this.model = data[2]; //"64", "256", "512"
      this.rtReserveTime = +data[3]; //preorder timestamp, number.
      this.firstValveUpdate = data[4]; //
      this.latestValveUpdate = data[5]; //
    }

    isReserveTimeAfter(other) {
      return this.rtReserveTime > other.rtReserveTime;
    }
  }

  class Data {
    constructor(responses) {
      this.responses = responses; //List of Response objects.
    }

    //Returns all responses where the model matches.
    whereModelIs(model) {
      return new Data(this.responses.filter(response => response.model === model));
    }

    //Returns all responses where the model matches.
    whereRegionIs(region) {
      return new Data(this.responses.filter(response => response.region === region));
    }

    sortByPreorderTimestamp() {
      return new Data(this.responses.sort((a, b) => a.rtReserveTime - b.rtReserveTime));
    }

  }

  function dataFromCSVString(data, name) {
    const parsed = parseCSV(data);
    let responses = [];
    for (let i = 1; i < parsed.length; i++) {
      responses.push(new Response(parsed[i]));
    }
    loaded_data = new Data(responses);
    document.getElementById('loaded_data').innerHTML = name;
  }

  function getData(url) {
    fetch(url).then(response => response.text()).then((data) => dataFromCSVString(data, url.slice(0, -4)));
  }

  async function calculate(algorythm) {
    algo = algorythm.name;
    if (loaded_data == null) {
      alert('No data loaded');
      return;
    }

    calculate_error = undefined;
    try {
      result = await algorythm({
        model: getLocalStorageOrDefault("model"),
        region: getLocalStorageOrDefault("region"),
        rtReserveTime: getLocalStorageOrDefault("rtReserveTime"),
        order_avail: getLocalStorageOrDefault("order_avail"),
      }, loaded_data);
    } catch (e) {
      console.log(e);
      calculate_error = e;
    }
    update_data();
  }

  getData('2-11-22-hoxeel-filtered.csv');
</script>

<!-- Import calculators -->
<script src="calculators/moo.js"></script>
<script src="calculators/gecked.js"></script>
<script src="calculators/abyzma.js"></script>